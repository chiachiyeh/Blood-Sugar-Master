!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>控糖智慧小幫手</title>
    <!-- 引入 React 與 Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    // --- 圖示組件 (SVG) ---
    const Icon = ({ children, className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            {children}
        </svg>
    );

    const Icons = {
        Activity: (props) => <Icon {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></Icon>,
        Utensils: (props) => <Icon {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></Icon>,
        Info: (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>,
        CheckCircle2: (props) => <Icon {...props}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></Icon>,
        AlertCircle: (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>,
        Baby: (props) => <Icon {...props}><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5"/><path d="M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.8 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.8A9 9 0 0 1 12 3c2 0 3.5 1.1 3.5 2.5s-.9 2.5-2 2.5-2-1-2-1.5.7-1.5 1.5-1.5c.5 0 1 .5 1 .5"/></Icon>,
        User: (props) => <Icon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
        UserPlus: (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></Icon>,
        HeartPulse: (props) => <Icon {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="M3.22 12H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27"/></Icon>,
        Hospital: (props) => <Icon {...props}><path d="M12 6V4"/><path d="M16.5 4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h3c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2Z"/><path d="M7.5 4c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2h-3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2Z"/><path d="M10 10h4"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M10 14h4"/><path d="M8 14h.01"/><path d="M16 14h.01"/></Icon>,
        UserCheck: (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></Icon>,
        Sparkles: (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></Icon>,
        MessageCircleQuestion: (props) => <Icon {...props}><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></Icon>,
        Send: (props) => <Icon {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></Icon>,
        Loader2: (props) => <Icon {...props} className={`animate-spin ${props.className || ''}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>,
        Bot: (props) => <Icon {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></Icon>,
        Key: (props) => <Icon {...props}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></Icon>
    };

    // --- 資料庫定義 ---
    const GLUCOSE_STANDARDS = {
      normal: {
        label: "一般民眾 (非糖尿病篩檢)",
        icon: <Icons.UserCheck />,
        targets: {
          fasting: "< 100",
          postMeal: "< 140",
          hba1c: "4.0 - 5.6",
          note: "若數值偏高 (空腹100-125, 飯後140-199, A1C 5.7-6.4) 則屬於「糖尿病前期」，建議儘早調整飲食運動。"
        }
      },
      child: {
        label: "18歲以下 (第一型糖尿病)",
        icon: <Icons.Baby />,
        targets: {
          fasting: "90 - 130",
          postMeal: "90 - 180",
          bedtime: "90 - 150",
          hba1c: "< 7.0",
          note: "兒童需注意低血糖風險，睡前血糖標準較高。"
        }
      },
      adult: {
        label: "20 - 65 歲 (一般成年糖尿病友)",
        icon: <Icons.User />,
        targets: {
          fasting: "80 - 130",
          postMeal2h: "80 - 160",
          hba1c: "< 7.0",
          bp: "< 130/80",
          note: "若有併發症、罹病時間長或常發生低血糖，可與醫師討論放寬標準。"
        }
      },
      pregnant: {
        label: "懷孕婦女 (妊娠糖尿病)",
        icon: <Icons.UserPlus />,
        targets: {
          fasting: "≤ 95",
          postMeal1h: "≤ 140",
          postMeal2h: "≤ 120",
          hba1c: "< 6.0",
          ga: "< 15.8 (糖化白蛋白)",
          note: "懷孕期間控制需較嚴格，可參考糖化白蛋白指標。"
        }
      },
      hospital: {
        label: "住院病人",
        icon: <Icons.Hospital />,
        targets: {
          range: "140 - 180",
          note: "住院期間血糖太高太低都有風險，維持在此範圍最安全。"
        }
      },
      elderly: {
        label: "65 歲以上老年人",
        icon: <Icons.User />,
        subCategories: {
          good: {
            status: "正常 (良好)",
            desc: "少共病症、認知及身體機能正常",
            targets: { fasting: "80 - 130", bedtime: "80 - 180", hba1c: "< 7 - 7.5", bp: "< 140/90" }
          },
          moderate: {
            status: "中等",
            desc: "多共病症、認知/身體機能輕微異常",
            targets: { fasting: "90 - 150", bedtime: "100 - 180", hba1c: "< 8.0", bp: "< 140/90" }
          },
          poor: {
            status: "差 (不佳)",
            desc: "末期慢性病、認知/身體機能嚴重異常",
            targets: { fasting: "100 - 180", bedtime: "110 - 200", hba1c: "不設定目標", bp: "< 150/90" }
          }
        }
      }
    };

    const CATEGORY_STYLES = {
      carb: { color: 'bg-yellow-100 border-yellow-400 text-yellow-900', portionDefault: '1/4 餐盤' },
      protein: { color: 'bg-red-100 border-red-400 text-red-900', portionDefault: '1/4 餐盤' },
      veg: { color: 'bg-green-100 border-green-400 text-green-900', portionDefault: '1/2 餐盤' },
      fruit: { color: 'bg-orange-100 border-orange-400 text-orange-900', portionDefault: '1天2份' },
      dairy: { color: 'bg-blue-100 border-blue-400 text-blue-900', portionDefault: '1天1-2杯' },
      fat: { color: 'bg-gray-100 border-gray-400 text-gray-800', portionDefault: '適量' },
      unknown: { color: 'bg-slate-100 border-slate-400 text-slate-800', portionDefault: '未知' }
    };

    const App = () => {
      // API Key 管理
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
      const [showKeyInput, setShowKeyInput] = useState(!localStorage.getItem('gemini_api_key'));

      const saveKey = (key) => {
        setApiKey(key);
        localStorage.setItem('gemini_api_key', key);
        setShowKeyInput(false);
      };

      const [activeTab, setActiveTab] = useState('glucose');
      const [age, setAge] = useState('');
      const [isPregnant, setIsPregnant] = useState(false);
      const [isHospitalized, setIsHospitalized] = useState(false);
      const [isNonDiabetic, setIsNonDiabetic] = useState(false);
      const [elderlyHealth, setElderlyHealth] = useState('good');
      const [resultProfile, setResultProfile] = useState(null);

      const [foodInput, setFoodInput] = useState('');
      const [foodResult, setFoodResult] = useState(null);
      const [isAnalyzingFood, setIsAnalyzingFood] = useState(false);

      const [chatInput, setChatInput] = useState('');
      const [chatHistory, setChatHistory] = useState([
        { role: 'ai', content: '您好！我是您的 AI 糖尿病衛教小幫手。有關血糖控制、飲食或運動的問題都可以問我喔！' }
      ]);
      const [isChatLoading, setIsChatLoading] = useState(false);

      // --- 邏輯函數 ---
      const calculateTarget = () => {
        if (isNonDiabetic) { setResultProfile({ type: 'normal', data: GLUCOSE_STANDARDS.normal }); return; }
        if (isHospitalized) { setResultProfile({ type: 'hospital', data: GLUCOSE_STANDARDS.hospital }); return; }
        if (isPregnant) { setResultProfile({ type: 'pregnant', data: GLUCOSE_STANDARDS.pregnant }); return; }
        
        const ageNum = parseInt(age);
        if (!ageNum && ageNum !== 0) { alert("請輸入年齡以進行評估"); return; }
        if (ageNum < 18) { setResultProfile({ type: 'child', data: GLUCOSE_STANDARDS.child }); }
        else if (ageNum >= 65) { setResultProfile({ type: 'elderly', data: GLUCOSE_STANDARDS.elderly, subType: elderlyHealth }); }
        else { setResultProfile({ type: 'adult', data: GLUCOSE_STANDARDS.adult }); }
      };

      const checkApiKey = () => {
        if (!apiKey) {
            alert('請先點擊右上角鑰匙圖示，輸入您的 Gemini API Key 才能使用 AI 功能喔！');
            setShowKeyInput(true);
            return false;
        }
        return true;
      };

      const analyzeFoodWithAI = async () => {
        if (!foodInput.trim()) return;
        if (!checkApiKey()) return;

        setIsAnalyzingFood(true);
        setFoodResult(null);

        const prompt = `你是一位專業的糖尿病衛教師與營養師。請分析食物：「${foodInput}」。請回傳一個純 JSON 物件(不要有 markdown)，格式如下：{"key": "carb"|"protein"|"veg"|"fruit"|"dairy"|"fat"|"unknown", "category": "類別名稱", "portion": "建議份量", "impact": "血糖影響", "advice": "簡短建議(30字內)"}`;

        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            }
          );
          const data = await response.json();
          if(data.error) throw new Error(data.error.message);
          
          let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
          text = text.replace(/```json/g, '').replace(/```/g, '').trim();
          const result = JSON.parse(text);
          const style = CATEGORY_STYLES[result.key] || CATEGORY_STYLES.unknown;
          setFoodResult({ ...result, ...style });
        } catch (error) {
          console.error(error);
          setFoodResult({
            category: "分析失敗", impact: "請檢查 API Key", portion: "-", advice: "無法連接 AI 服務: " + error.message,
            color: CATEGORY_STYLES.unknown.color, key: "unknown"
          });
        } finally {
          setIsAnalyzingFood(false);
        }
      };

      const sendChatMessage = async () => {
        if (!chatInput.trim()) return;
        if (!checkApiKey()) return;
        
        const userMsg = { role: 'user', content: chatInput };
        setChatHistory(prev => [...prev, userMsg]);
        setChatInput('');
        setIsChatLoading(true);

        const prompt = `你是一位糖尿病衛教專家。請用繁體中文回答：「${chatInput}」。原則：鼓勵、引用指引、不進行醫療診斷、精簡。`;

        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            }
          );
          const data = await response.json();
          if(data.error) throw new Error(data.error.message);
          const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
          setChatHistory(prev => [...prev, { role: 'ai', content: aiText }]);
        } catch (error) {
          setChatHistory(prev => [...prev, { role: 'ai', content: "發生錯誤：" + error.message }]);
        } finally {
          setIsChatLoading(false);
        }
      };

      useEffect(() => {
        if (isNonDiabetic) { setIsHospitalized(false); setIsPregnant(false); }
      }, [isNonDiabetic]);
      useEffect(() => {
        if (isHospitalized || isPregnant) { setIsNonDiabetic(false); }
      }, [isHospitalized, isPregnant]);

      return (
        <div className="min-h-screen pb-20 max-w-md mx-auto bg-slate-50 border-x border-slate-200 shadow-2xl relative">
          
          {/* Header */}
          <header className="bg-emerald-600 text-white p-4 shadow-md sticky top-0 z-30 flex justify-between items-center">
            <div className="flex items-center gap-2">
              <Icons.HeartPulse className="text-emerald-100" />
              <h1 className="text-xl font-bold">控糖智慧小幫手</h1>
            </div>
            <button onClick={() => setShowKeyInput(!showKeyInput)} className="p-2 bg-emerald-700 rounded-full hover:bg-emerald-800 transition">
                <Icons.Key size={16} />
            </button>
          </header>

          {/* API Key Input Overlay */}
          {showKeyInput && (
            <div className="bg-white p-4 m-4 rounded-xl shadow-xl border-2 border-orange-200 animate-slideUp z-40">
                <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <Icons.Key size={20} className="text-orange-500"/> 設定 API Key
                </h3>
                <p className="text-xs text-gray-500 mb-2">請輸入您的 Google Gemini API Key 以啟用 AI 功能。金鑰僅會儲存在您的瀏覽器中。</p>
                <div className="flex gap-2">
                    <input 
                        type="password" 
                        value={apiKey} 
                        onChange={(e) => setApiKey(e.target.value)}
                        placeholder="輸入 API Key..."
                        className="flex-1 border p-2 rounded text-sm"
                    />
                    <button onClick={() => saveKey(apiKey)} className="bg-emerald-600 text-white px-3 py-1 rounded text-sm font-bold">儲存</button>
                </div>
            </div>
          )}

          <div className="p-4">
            <div className="flex bg-white rounded-xl shadow-sm p-1 mb-6 sticky top-20 z-20">
              {['glucose', 'diet', 'consult'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} 
                  className={`flex-1 py-2 rounded-lg text-sm font-bold flex flex-col items-center gap-1 transition ${activeTab === tab ? 'bg-emerald-100 text-emerald-700' : 'text-gray-400 hover:bg-gray-50'}`}>
                  {tab === 'glucose' && <Icons.Activity size={20} />}
                  {tab === 'diet' && <Icons.Utensils size={20} />}
                  {tab === 'consult' && <Icons.MessageCircleQuestion size={20} />}
                  <span className="text-xs">{tab === 'glucose' ? '血糖試算' : tab === 'diet' ? 'AI 飲食' : '問 AI'}</span>
                </button>
              ))}
            </div>

            {/* Content: 血糖 */}
            {activeTab === 'glucose' && (
              <div className="space-y-6 animate-fadeIn">
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                  <h2 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700">
                    <Icons.Info size={20} className="text-emerald-500" /> 設定狀態
                  </h2>
                  <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                       <label className={`border p-3 rounded-xl cursor-pointer transition flex flex-col items-center gap-1 ${isNonDiabetic ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-gray-200'}`}>
                        <input type="checkbox" className="hidden" checked={isNonDiabetic} onChange={e => setIsNonDiabetic(e.target.checked)} />
                        <Icons.UserCheck size={24} /><span className="text-sm font-medium">一般民眾</span>
                      </label>
                       <label className={`border p-3 rounded-xl cursor-pointer transition flex flex-col items-center gap-1 ${isHospitalized ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-200'}`}>
                        <input type="checkbox" className="hidden" checked={isHospitalized} onChange={e => setIsHospitalized(e.target.checked)} />
                        <Icons.Hospital size={24} /><span className="text-sm font-medium">住院中</span>
                      </label>
                      <label className={`border p-3 rounded-xl cursor-pointer transition flex flex-col items-center gap-1 ${isPregnant ? 'bg-pink-50 border-pink-500 text-pink-700' : 'border-gray-200'}`}>
                        <input type="checkbox" className="hidden" checked={isPregnant} onChange={e => setIsPregnant(e.target.checked)} />
                        <Icons.Baby size={24} /><span className="text-sm font-medium">懷孕糖友</span>
                      </label>
                    </div>

                    {!isHospitalized && !isPregnant && !isNonDiabetic && (
                      <div className="animate-fadeIn">
                        <label className="block text-sm font-medium text-gray-600 mb-1">年齡 (歲)</label>
                        <input type="number" value={age} onChange={(e) => setAge(e.target.value)} placeholder="輸入年齡" className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-400 focus:outline-none" />
                      </div>
                    )}

                    {!isHospitalized && !isPregnant && !isNonDiabetic && parseInt(age) >= 65 && (
                      <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 animate-fadeIn">
                        <label className="block text-sm font-bold text-orange-800 mb-2">健康狀況評估：</label>
                        <div className="space-y-2">
                          {Object.entries(GLUCOSE_STANDARDS.elderly.subCategories).map(([key, info]) => (
                            <label key={key} className="flex items-start gap-3 p-2 rounded-lg hover:bg-orange-100/50 cursor-pointer">
                              <input type="radio" name="elderlyHealth" value={key} checked={elderlyHealth === key} onChange={(e) => setElderlyHealth(e.target.value)} className="mt-1 accent-orange-500" />
                              <div><div className="font-bold text-gray-800 text-sm">{info.status}</div><div className="text-xs text-gray-500">{info.desc}</div></div>
                            </label>
                          ))}
                        </div>
                      </div>
                    )}
                    <button onClick={calculateTarget} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-emerald-700 active:scale-95 transition">計算目標</button>
                  </div>
                </div>

                {resultProfile && (
                  <div className="bg-white p-0 rounded-2xl shadow-lg border border-emerald-100 overflow-hidden animate-slideUp">
                    <div className={`p-4 text-white flex items-center gap-2 ${resultProfile.type === 'normal' ? 'bg-indigo-500' : 'bg-emerald-600'}`}>
                      {resultProfile.data.icon}
                      <span className="font-bold text-lg">{resultProfile.type === 'elderly' ? `老年人 - ${resultProfile.data.subCategories[resultProfile.subType].status}` : resultProfile.data.label}</span>
                    </div>
                    <div className="p-5 space-y-4">
                      <div className="grid grid-cols-2 gap-3">
                        {(() => {
                          const targets = resultProfile.type === 'elderly' ? resultProfile.data.subCategories[resultProfile.subType].targets : resultProfile.data.targets;
                          return Object.entries(targets).map(([key, value]) => {
                            if (key === 'note') return null;
                            const labels = { fasting: '空腹血糖', postMeal: '飯後血糖', postMeal1h: '飯後1H', postMeal2h: '飯後2H', bedtime: '睡前血糖', hba1c: '糖化血色素', bp: '血壓', ga: '糖化白蛋白', range: '血糖範圍' };
                            return (
                              <div key={key} className="bg-gray-50 p-3 rounded-xl text-center border border-gray-100">
                                <div className="text-xs text-gray-500 mb-1">{labels[key] || key}</div>
                                <div className="text-xl font-bold text-emerald-600">{value}</div>
                              </div>
                            );
                          });
                        })()}
                      </div>
                      <div className="bg-yellow-50 text-yellow-800 text-sm p-3 rounded-lg flex gap-2 items-start">
                        <Icons.AlertCircle size={16} className="mt-0.5 shrink-0" />
                        <p>{resultProfile.type === 'elderly' ? "醫師備註：隨著健康狀況變差，目標可適度放寬，避免低血糖。" : resultProfile.data.targets.note}</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Content: AI 飲食 */}
            {activeTab === 'diet' && (
              <div className="space-y-6 animate-fadeIn">
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center">
                  <h3 className="font-bold text-slate-700 mb-4">211 健康餐盤</h3>
                  <div className="relative w-64 h-64 rounded-full border-4 border-slate-200 overflow-hidden shadow-inner flex flex-wrap bg-white">
                    <div className={`w-1/2 h-full border-r border-white flex items-center justify-center p-2 text-center transition-colors duration-500 ${foodResult?.key === 'veg' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-800'}`}>
                      <div><div className="font-bold text-lg">蔬菜類</div><div className="text-xs">1/2 盤</div></div>
                    </div>
                    <div className="w-1/2 h-full flex flex-col">
                      <div className={`h-1/2 w-full border-b border-white flex items-center justify-center p-1 text-center transition-colors duration-500 ${foodResult?.key === 'protein' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-800'}`}>
                         <div><div className="font-bold">蛋白質</div><div className="text-xs">1/4 盤</div></div>
                      </div>
                      <div className={`h-1/2 w-full flex items-center justify-center p-1 text-center transition-colors duration-500 ${foodResult?.key === 'carb' ? 'bg-yellow-400 text-yellow-900' : 'bg-yellow-100 text-yellow-800'}`}>
                        <div><div className="font-bold">全穀類</div><div className="text-xs">1/4 盤</div></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="bg-white p-5 rounded-2xl shadow-lg border border-indigo-50 relative overflow-hidden">
                  <div className="absolute top-0 right-0 p-2 opacity-10"><Icons.Sparkles size={80} className="text-indigo-500"/></div>
                  <label className="block text-sm font-bold text-indigo-900 mb-2 flex items-center gap-2">
                    <Icons.Sparkles size={16} className="text-indigo-500" /> AI 飲食分析
                  </label>
                  <div className="flex gap-2 mb-4">
                    <input type="text" value={foodInput} onChange={(e) => setFoodInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && analyzeFoodWithAI()} placeholder="輸入食物 (如: 排骨飯)..." className="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:outline-none" />
                    <button onClick={analyzeFoodWithAI} disabled={isAnalyzingFood || !foodInput.trim()} className="bg-indigo-600 text-white px-4 rounded-xl font-bold shadow hover:bg-indigo-700 active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                      {isAnalyzingFood ? <Icons.Loader2 size={20} className="animate-spin" /> : '分析'}
                    </button>
                  </div>

                  {foodResult && (
                    <div className={`p-4 rounded-xl border-l-4 animate-slideUp ${foodResult.color}`}>
                      <div className="flex justify-between items-start mb-2">
                        <span className="font-bold text-lg">{foodResult.category}</span>
                        <span className="text-xs bg-white/60 px-2 py-1 rounded-full font-bold shadow-sm">{foodResult.impact}</span>
                      </div>
                      <div className="space-y-2 text-sm">
                        <div className="flex items-start gap-2"><Icons.CheckCircle2 size={16} className="mt-0.5 opacity-70 shrink-0" /><span>建議：<span className="font-bold">{foodResult.portion}</span></span></div>
                        <div className="flex items-start gap-2"><Icons.Info size={16} className="mt-0.5 opacity-70 shrink-0" /><span className="leading-relaxed">{foodResult.advice}</span></div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Content: AI 諮詢 */}
            {activeTab === 'consult' && (
              <div className="flex flex-col h-[60vh] bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden animate-fadeIn">
                <div className="bg-emerald-50 p-4 border-b border-emerald-100 flex items-center gap-3">
                  <div className="bg-white p-2 rounded-full shadow-sm"><Icons.Bot size={24} className="text-emerald-600"/></div>
                  <div><div className="font-bold text-emerald-800">AI 衛教諮詢室</div><div className="text-xs text-emerald-600">有任何問題都可以問我！</div></div>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                  {chatHistory.map((msg, idx) => (
                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === 'user' ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white text-slate-700 rounded-tl-none border border-slate-100'}`}>
                        {msg.content}
                      </div>
                    </div>
                  ))}
                  {isChatLoading && <div className="flex justify-start"><div className="bg-white p-3 rounded-2xl rounded-tl-none border border-slate-100 shadow-sm flex gap-2 items-center text-slate-500 text-sm"><Icons.Loader2 size={16} className="animate-spin" /> AI 正在思考中...</div></div>}
                </div>
                <div className="p-3 bg-white border-t border-slate-100 flex gap-2">
                  <input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && sendChatMessage()} placeholder="請輸入您的問題..." className="flex-1 p-3 bg-slate-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400 text-sm" />
                  <button onClick={sendChatMessage} disabled={isChatLoading || !chatInput.trim()} className="bg-emerald-600 text-white p-3 rounded-xl hover:bg-emerald-700 active:scale-95 transition disabled:opacity-50"><Icons.Send size={20} /></button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>